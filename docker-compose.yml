x-base-common: &base-common
  networks:
    - internal_net
    - default
  depends_on:
    caddy: { condition: service_healthy }
    verdaccio: { condition: service_healthy }

services:
  caddy:
    build:
      context: .
      dockerfile: docker/Dockerfile.caddy
    networks: [internal_net]
    expose: ['2019']
    healthcheck:
      test: ['CMD-SHELL', 'caddy version >/dev/null 2>&1 || exit 1']
      interval: 5s
      timeout: 3s
      retries: 10

  verdaccio:
    image: verdaccio/verdaccio:6
    networks:
      - internal_net
      - default
    volumes:
      - ./docker/verdaccio/config.yaml:/verdaccio/conf/config.yaml
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'node -e "require(''http'').get(''http://localhost:4873/-/ping'',r=>process.exit(r.statusCode===200?0:1)).on(''error'',()=>process.exit(1))"',
        ]
      interval: 5s
      timeout: 5s
      retries: 30

  base_dev:
    <<: *base-common
    profiles: ['dev']
    build:
      context: .
      dockerfile: docker/Dockerfile.base
    environment:
      CHOKIDAR_USEPOLLING: 'true'
      DOCKER_MODE: dev
    volumes:
      - ./integration:/apps/base/integration:rw
      - ./src:/apps/base/src:rw

  base_test:
    <<: *base-common
    profiles: ['test']
    build:
      context: .
      dockerfile: docker/Dockerfile.base
    environment:
      DOCKER_MODE: test
      GITHUB_ACTIONS: ${GITHUB_ACTIONS:-false}

networks:
  internal_net:
    internal: true
